AWSTemplateFormatVersion: '2010-09-09'
Description: Docker Swarm cluster deployed with InfraKit 

Mappings:
  AMI:
    # Ubuntu 16.04 HVM
    eu-central-1:
      Ubuntu: ami-2830f947
    eu-west-1:
      Ubuntu: ami-98ecb7fe
    us-east-1:
      Ubuntu: ami-f0768de6
    us-west-1:
      Ubuntu: ami-79df8219
    us-west-2:
      Ubuntu: ami-d206bdb2
  VpcCidrs:
    subnet1:
      cidr: 192.168.2.0/24
    vpc:
      cidr: 192.168.0.0/16

Parameters:
  InstanceType:
    Type: String
    AllowedValues:
    - t2.micro
    - t2.small
    - t2.medium
    - t2.large
    - m3.medium
    - m4.large
    ConstraintDescription: Must be a valid EC2 HVM instance type
    Default: t2.micro
    Description: EC2 HVM instance type (t2.micro, m3.medium, etc)
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    MinLength: '1'
  InfraKitConfigurationBaseURL:
    Type: String
    ConstraintDescription: must be an URL
    Description: Base URL for InfraKit configuration. there should be a bootstrap.sh, a variables.ikt and a config.tpl file
    Default: https://raw.githubusercontent.com/ndegory/swarm-infrakit/master

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Fn::FindInMap:
        - VpcCidrs
        - vpc
        - cidr
      EnableDnsHostnames: 'true'
      EnableDnsSupport: 'true'
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - '-'
          - - Ref: AWS::StackName
            - VPC
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    DependsOn: Vpc
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - '-'
          - - Ref: AWS::StackName
            - IGW
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    DependsOn:
    - Vpc
    - InternetGateway
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId:
        Ref: Vpc
  RouteViaIgw:
    Type: AWS::EC2::RouteTable
    DependsOn: Vpc
    Properties:
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - '-'
          - - Ref: AWS::StackName
            - RT
      VpcId:
        Ref: Vpc
  PublicRouteViaIgw:
    Type: AWS::EC2::Route
    DependsOn:
    - AttachGateway
    - RouteViaIgw
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: RouteViaIgw
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    DependsOn: InternetGateway
    Properties:
      GroupDescription: VPC-wide security group
      SecurityGroupIngress:
      - CidrIp:
          Fn::FindInMap:
          - VpcCidrs
          - vpc
          - cidr
        IpProtocol: '-1'
      - CidrIp: 0.0.0.0/0
        IpProtocol: tcp
        FromPort: '22'
        ToPort: '22'
      - CidrIp: 0.0.0.0/0
        IpProtocol: tcp
        FromPort: '80'
        ToPort: '80'
      - CidrIp: 0.0.0.0/0
        IpProtocol: tcp
        FromPort: '443'
        ToPort: '443'
      VpcId:
        Ref: Vpc
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    DependsOn: Vpc
    Properties:
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Fn::GetAZs:
            Ref: AWS::Region
      CidrBlock:
        Fn::FindInMap:
        - VpcCidrs
        - subnet1
        - cidr
      MapPublicIpOnLaunch: true
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - '-'
          - - Ref: AWS::StackName
            - PublicSubnet1
      VpcId:
        Ref: Vpc
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
    - PublicSubnet1
    - RouteViaIgw
    Properties:
      RouteTableId:
        Ref: RouteViaIgw
      SubnetId:
        Ref: PublicSubnet1
  ProvisionerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
        Version: '2012-10-17'
      Path: /
  ProvisionerPolicies:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
        - Action: '*'
          Effect: Allow
          Resource: '*'
        Version: '2012-10-17'
      PolicyName: managers-policy
      Roles:
      - Ref: ProvisionerRole
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - Ref: ProvisionerRole
  BootstrapInstance:
    Type: AWS::EC2::Instance
    DependsOn: PublicSubnet1
    Properties:
      SubnetId: !Ref PublicSubnet1
      SecurityGroupIds:
        - !GetAtt SecurityGroup.GroupId
      AvailabilityZone: !GetAtt PublicSubnet1.AvailabilityZone
      IamInstanceProfile: !Ref InstanceProfile
      ImageId:
        Fn::FindInMap:
        - AMI
        - Ref: AWS::Region
        - Ubuntu
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      Tags:
      - Key: Name
        Value:
          Fn::Join:
          - '-'
          - - Ref: AWS::StackName
            - controller
      - Key: infrakit.group
        Value: swarm-managers
      - Key: infrakit.role
        Value: managers
      UserData:
        "Fn::Base64":
          !Sub
            - |
              #cloud-config
              repo_update: true
              repo_upgrade: security
              packages:
                - ca-certificates
                - jq
                - curl
                - unzip
                - awscli
              write_files:
                - path: /infrakit/env.ikt
                  content: |
                    {{/* Global variables */}}
                    {{ global "/aws/region" "${region}" }}
                    {{ global "/aws/stackname" "${stackname}" }}
                    {{ global "/aws/vpcid" "${vpcid}" }}
                    {{ global "/aws/subnetid" "${subnetid}" }}
                    {{ global "/aws/securitygroupid" "${sgid}" }}
                    {{ global "/aws/amiid" "${ami}" }}
                    {{ global "/aws/instancetype" "${type}" }}
                    {{ global "/aws/keyname" "${key}" }}
              runcmd:
                - wget -qO- https://get.docker.com/ | sh
                - usermod -G docker ubuntu
                - systemctl enable docker.service
                - systemctl start docker.service
                - curl ${InfraKitConfigurationBaseURL}/bootstrap.sh -o /usr/local/bin/bootstrap.sh
                - bash /usr/local/bin/bootstrap.sh ${InfraKitConfigurationBaseURL}
            - { ami: !FindInMap [ AMI, !Ref "AWS::Region", Ubuntu ], stackname: !Ref "AWS::StackName", region: !Ref "AWS::Region", vpcid: !Ref Vpc, subnetid: !Ref PublicSubnet1, sgid: !Ref SecurityGroup, type: !Ref InstanceType, key: !Ref KeyName }

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Cluster Properties
      Parameters:
      - InstanceType
      - KeyName
    - Label:
        default: InfraKit Configuration
      Parameters:
      - InfraKitConfigurationBaseURL
    ParameterLabels:
      InstanceType:
        default: Agent worker instance type?
      KeyName:
        default: Which SSH key to use?
      InfraKitConfigurationBaseURL:
        default: InfraKit configuration base URL

Outputs:
  BootNodePublicIP:
    Description: The public IP of the boot node
    Value:
      Fn::GetAtt:
      - BootstrapInstance
      - PublicIp
